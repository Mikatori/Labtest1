# Firebase Database Schema

This document describes the Firestore database structure for the Virtual Environmental Lab application.

## Collections

### `users`

Stores user profile information beyond what Firebase Authentication provides.

**Document ID**: Firebase Auth UID (string)

**Fields:**
- `email` (string): User's email address
- `displayName` (string): User's full name
- `classCode` (string): Student's class code (e.g., "ENV2024-A")
- `createdAt` (timestamp): Account creation timestamp

**Example:**
```json
{
  "email": "student@example.edu.vn",
  "displayName": "Nguyễn Văn A",
  "classCode": "ENV2024-A",
  "createdAt": "2024-01-29T10:00:00.000Z"
}
```

**Indexes:**
- `classCode` (ascending): For querying students by class
- `createdAt` (descending): For sorting by registration date

---

### `labSessions`

Tracks individual lab practice sessions for each user and lab type.

**Document ID**: Auto-generated by Firestore

**Fields:**
- `userId` (string): Reference to user ID (Firebase Auth UID)
- `labType` (string): Type of lab - one of: `'COD'`, `'BOD'`, `'WATER'`, `'AIR'`
- `status` (string): Session status - one of: `'in-progress'`, `'completed'`, `'abandoned'`
- `mode` (string): Practice mode - one of: `'guided'`, `'practice'`
- `currentStep` (number): Current step index in the lab workflow (0-based)
- `startTime` (timestamp): Session start timestamp
- `endTime` (timestamp | null): Session end timestamp (null if in-progress)
- `score` (object | null): Scoring breakdown (null if not completed)
  - `accuracy` (number): Accuracy score (0-100)
  - `safety` (number): Safety compliance score (0-100)
  - `efficiency` (number): Time efficiency score (0-100)
  - `total` (number): Overall score (average of above three)
- `measurements` (object): Lab-specific measurement data
  - For COD: `{ sampleVolume, dichromateVolume, acidVolume, temperature, heatingTime, absorbance, codValue }`
  - For BOD: `{ sampleVolume, dilutionFactor, initialDO, finalDO, bod5Value }`
  - For WATER: `{ ph, turbidity, temperature, dissolvedOxygen }`
  - For AIR: `{ co2, pm25, pm10, temperature, humidity, aqi }`
- `errors` (array): List of errors/warnings encountered
  - Each error object contains:
    - `step` (number): Step number where error occurred
    - `errorType` (string): Type of error (e.g., "wrong_chemical", "volume_incorrect", "safety_violation")
    - `message` (string): Error message displayed to user
    - `timestamp` (timestamp): When the error occurred

**Example:**
```json
{
  "userId": "abc123xyz",
  "labType": "COD",
  "status": "completed",
  "mode": "guided",
  "currentStep": 8,
  "startTime": "2024-01-29T10:30:00.000Z",
  "endTime": "2024-01-29T10:52:00.000Z",
  "score": {
    "accuracy": 95,
    "safety": 100,
    "efficiency": 88,
    "total": 94
  },
  "measurements": {
    "sampleVolume": 2.5,
    "dichromateVolume": 1.5,
    "acidVolume": 3.5,
    "temperature": 150,
    "heatingTime": 120,
    "absorbance": 0.425,
    "codValue": 248
  },
  "errors": [
    {
      "step": 2,
      "errorType": "volume_warning",
      "message": "Thể tích hơi lệch. Đã thêm 1.6ml thay vì 1.5ml",
      "timestamp": "2024-01-29T10:35:00.000Z"
    }
  ]
}
```

**Indexes:**
- Composite index: `userId` (ascending) + `labType` (ascending) + `startTime` (descending)
- Composite index: `userId` (ascending) + `status` (ascending) + `startTime` (descending)
- Single field: `status` (ascending)

---

## Security Rules

The following Firestore security rules should be applied:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Users can only read/write their own lab sessions
    match /labSessions/{sessionId} {
      allow read, write: if request.auth != null && 
                            resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                      request.resource.data.userId == request.auth.uid;
    }
  }
}
```

---

## Data Operations

### Creating a User Profile
Done automatically during registration in `AuthContext.tsx`:

```typescript
await setDoc(doc(db, 'users', user.uid), {
  email,
  displayName,
  classCode,
  createdAt: new Date(),
});
```

### Starting a Lab Session
When a user starts a lab:

```typescript
import { collection, addDoc } from 'firebase/firestore';

const sessionRef = await addDoc(collection(db, 'labSessions'), {
  userId: currentUser.uid,
  labType: 'COD', // or 'BOD', 'WATER', 'AIR'
  status: 'in-progress',
  mode: 'guided', // or 'practice'
  currentStep: 0,
  startTime: new Date(),
  endTime: null,
  score: null,
  measurements: {},
  errors: [],
});
```

### Updating Lab Progress
As the user progresses through steps:

```typescript
import { doc, updateDoc } from 'firebase/firestore';

await updateDoc(doc(db, 'labSessions', sessionId), {
  currentStep: newStep,
  'measurements.sampleVolume': 2.5,
  // Add to errors array
  errors: arrayUnion({
    step: 2,
    errorType: 'volume_warning',
    message: 'Volume slightly off',
    timestamp: new Date(),
  }),
});
```

### Completing a Lab Session
When the lab is finished:

```typescript
await updateDoc(doc(db, 'labSessions', sessionId), {
  status: 'completed',
  endTime: new Date(),
  score: {
    accuracy: 95,
    safety: 100,
    efficiency: 88,
    total: 94,
  },
});
```

### Querying User's Lab History
To get all sessions for a user:

```typescript
import { collection, query, where, orderBy, getDocs } from 'firebase/firestore';

const q = query(
  collection(db, 'labSessions'),
  where('userId', '==', currentUser.uid),
  orderBy('startTime', 'desc')
);

const querySnapshot = await getDocs(q);
const sessions = querySnapshot.docs.map(doc => ({
  id: doc.id,
  ...doc.data(),
}));
```
